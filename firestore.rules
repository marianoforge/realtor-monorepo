rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ‚ùå BLOQUEADAS - Ya no se usan
    match /verifications/{document} {
      allow read, write: if false;
    }
    
    match /chat_responses/{document=**} {
      allow read, write: if false;
    }

    match /unanswered_questions/{document=**} {
      allow read, write: if false;
    }

    // ‚úÖ USUARIOS - Solo el propio usuario puede acceder a su documento
    match /usuarios/{userId} {
      allow read, write, update, delete: if request.auth != null && request.auth.uid == userId;
    }

    // ‚úÖ TEAMS - L√≠der puede gestionar, miembros pueden leer
    match /teams/{teamId} {
      allow read: if request.auth != null;
      allow write, update, delete: if request.auth != null && 
        (request.auth.uid == resource.data.teamLeadID || 
         request.auth.uid == request.resource.data.teamLeadID);
    }

    // ‚úÖ OPERATIONS - Usuario ve las suyas, l√≠der ve las del equipo
    match /operations/{operationId} {
      // Lectura: usuario ve las suyas (user_uid) O l√≠der ve las del equipo (teamId)
      allow read: if request.auth != null && 
        (request.auth.uid == resource.data.user_uid || 
         request.auth.uid == resource.data.teamId);
      // Crear: debe ser parte del equipo (teamId) o ser el usuario asignado
      allow create: if request.auth != null && 
        (request.auth.uid == request.resource.data.teamId ||
         request.auth.uid == request.resource.data.user_uid);
      // Actualizar/Eliminar: usuario propio o l√≠der del equipo
      allow update, delete: if request.auth != null && 
        (request.auth.uid == resource.data.user_uid || 
         request.auth.uid == resource.data.teamId);
    }

    // ‚úÖ EXPENSES - Usuario ve las suyas, l√≠der ve las del equipo
    match /expenses/{expenseId} {
      // Lectura: usuario ve las suyas O l√≠der ve las del equipo
      allow read: if request.auth != null && 
        (request.auth.uid == resource.data.user_uid ||
         request.auth.uid == resource.data.teamId);
      // Crear: el user_uid debe ser el usuario autenticado
      allow create: if request.auth != null && 
        request.auth.uid == request.resource.data.user_uid;
      // Actualizar/Eliminar: solo el due√±o o l√≠der del equipo
      allow update, delete: if request.auth != null && 
        (request.auth.uid == resource.data.user_uid ||
         request.auth.uid == resource.data.teamId);
    }

    // ‚úÖ EVENTS - Usuario ve los suyos, l√≠der ve los del equipo
    match /events/{eventId} {
      // Lectura: usuario ve los suyos O l√≠der ve los del equipo
      allow read: if request.auth != null && 
        (request.auth.uid == resource.data.user_uid ||
         request.auth.uid == resource.data.teamId);
      // Crear: el user_uid debe ser el usuario autenticado
      allow create: if request.auth != null && 
        request.auth.uid == request.resource.data.user_uid;
      // Actualizar/Eliminar: solo el due√±o o l√≠der del equipo
      allow update, delete: if request.auth != null && 
        (request.auth.uid == resource.data.user_uid ||
         request.auth.uid == resource.data.teamId);
    }

    // üîí BLOQUEO GENERAL - Todo lo dem√°s bloqueado por defecto
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
